name: CI Workflow with Trivy

on:
  workflow_dispatch:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  build:
    name: Build the Project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Grant permissions for gradlew
        run: chmod +x ./gradlew || true

      - name: Build the project
        run: ./gradlew clean build --no-daemon --stacktrace
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g"

  trivy:
    name: Vulnerability Scan with Trivy
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          echo "Instalando Trivy..."
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.45.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.45.0_Linux-64bit.deb

      - name: Run Trivy Vulnerability Scan
        run: |
          echo "Ejecutando Trivy en el proyecto..."
          trivy fs --scanners vuln --severity CRITICAL,HIGH ./src | tee trivy-report.txt

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-vulnerability-report
          path: trivy-report.txt