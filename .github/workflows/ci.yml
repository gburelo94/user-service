name: CI Workflow with Trivy for Gradle

on:
  workflow_dispatch:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  build:
    name: Build the Project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Grant permissions for gradlew
        run: chmod +x ./gradlew || true

      - name: Build the project
        run: ./gradlew clean build --no-daemon --stacktrace
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g"

      - name: Generate dependency report with Gradle
        run: ./gradlew dependencies > gradle-dependencies-report.txt

      - name: Verify Build Output
        run: |
          echo "Verificando archivos generados tras la compilaci√≥n..."
          ls -R ./build || echo "No se generaron artefactos en ./build"

  trivy:
    name: Vulnerability Scan with Trivy
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Trivy using Official Script
        run: |
          echo "Descargando e instalando Trivy con el script oficial..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Run Trivy Vulnerability Scan (Gradle dependencies)
        run: |
          echo "Escaneando dependencias de Gradle en ~/.gradle..."
          trivy fs --scanners vuln --severity CRITICAL,HIGH ~/.gradle | tee trivy-gradle-cache-report.txt

      - name: Run Trivy Vulnerability Scan (Build artefacts)
        run: |
          echo "Escaneando artefactos compilados en ./build/libs..."
          trivy fs --scanners vuln --severity CRITICAL,HIGH ./build/libs | tee trivy-build-libs-report.txt

      - name: Upload Trivy Reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            trivy-gradle-cache-report.txt
            trivy-build-libs-report.txt
            gradle-dependencies-report.txt